# Maintainer: Dominic Sisneros <dsisnero@gmail.com>

_realname=mtex2MML
pkgbase=mingw-w64-${_realname}
pkgname="${MINGW_PACKAGE_PREFIX}-${_realname}"
pkgver=1.3.1
pkgrel=3
pkgdesc="A Bison grammar to convert TeX math into MathML (mingw-w64)"
arch=('any')
url="https://github.com/gjtorikian/mtex2MML/"
license=('LGPL')
license=('GPL' 'MPL' 'LGPL')
makedepends=("${MINGW_PACKAGE_PREFIX}-python3"
             'bison'
             'flex'
             "${MINGW_PACKAGE_PREFIX}-cmake"
             "${MINGW_PACKAGE_PREFIX}-ninja"
             "${MINGW_PACKAGE_PREFIX}-pkg-config"
            )
options=('strip' 'staticlibs')
source=(${_realname}-${pkgver}.tar.gz::"https://github.com/gjtorikian/${_realname}/archive/v${pkgver}.tar.gz" 
        001-cmakelist.patch)
sha256sums=('977be19419572da01c4c86789c28a6a0d8cd74cdab6e30f77d6ab7dbd38e7195'
            'd59e23dfdb6e854ff2ad6f5225e360ee67127ae592ede8ee0822157777623a16')

prepare() {
  cd "${srcdir}/${_realname}-${pkgver}"
  patch --input="${srcdir}"/001-cmakelist.patch
}

build() {
    cd "${srcdir}"/${_realname}-${pkgver}
    [[ -d "${scrdir}"/build-${CARCH} ]] && rm -rf "${scrdir}"/build-${CARCH}
    mkdir -p "${srcdir}"/build-${CARCH}  && cd "${srcdir}"/build-${CARCH}

    declare -a extra_config
    if check_option "debug" "n"; then
        extra_config+=("-DCMAKE_BUILD=Release")
    else
        extra_config+=("-DCMAKE_BUILD_TYPE=Debug")
    fi
    


  MSYS2_ARG_CONV_EXCL="-DCMAKE_INSTALL_PREFIX=" \
  ${MINGW_PREFIX}/bin/cmake \
    -G"Ninja" \
    -DCMAKE_INSTALL_PREFIX="${MINGW_PREFIX}" \
    "${extra_config[@]}" \
    -DBUILD_{SHARED,STATIC}_LIBS=ON \
    ../${_realname}-${pkgver}

  ${MINGW_PREFIX}/bin/cmake --build .

}


 check() {
     cd "${srcdir}"/build-${CARCH}
     cmake --build . --target test
 }

package() {
  cd "${srcdir}"/build-${CARCH}
  DESTDIR="${pkgdir}" ${MINGW_PREFIX}/bin/cmake --build . --target install
}
